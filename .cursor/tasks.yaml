#!/usr/bin/env python
"""
generate_folder_tree.py
knowledge_root é…ä¸‹ã®ãƒ•ã‚©ãƒ«ãƒ€éšå±¤ï¼ˆæ·±ã•3ã¾ã§ï¼‰ã‚’
knowlage_grail/docs/folder_tree.md ã« UTF-8(BOMãªã—) ã§æ›¸ãå‡ºã™
"""

import os
from pathlib import Path
from datetime import datetime

ROOT = Path(__file__).resolve().parents[2]          # /knowledge_root
DOCS = ROOT / "knowlage_grail" / "docs"
OUT  = DOCS / "folder_tree.md"
LOG  = DOCS / "folder_tree.log"
MAX_DEPTH = 3

exclude = {'.git', '.venv', 'chroma'}               # ä¸è¦ãªå·¨å¤§ or å†…éƒ¨ãƒ•ã‚©ãƒ«ãƒ€

base_depth = ROOT.parts.__len__()

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«å®Ÿè¡Œæ™‚åˆ»ã‚’è¨˜éŒ²
with LOG.open('a', encoding='utf-8') as log:
    log.write(f"\n[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] ãƒ•ã‚©ãƒ«ãƒ€ãƒ„ãƒªãƒ¼æ›´æ–°é–‹å§‹\n")

with OUT.open('w', encoding='utf-8') as f:
    f.write(f"# ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆï¼ˆdepthâ‰¤3ï¼‰\n\n")
    f.write(f"æœ€çµ‚æ›´æ–°: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
    for root, dirs, _ in os.walk(ROOT):
        rel_depth = Path(root).parts.__len__() - base_depth
        if rel_depth < MAX_DEPTH:
            if any(part in exclude for part in Path(root).parts):
                continue
            indent = '    ' * rel_depth
            f.write(f"{indent}- {Path(root).name}/\n")

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«å®Œäº†ã‚’è¨˜éŒ²
with LOG.open('a', encoding='utf-8') as log:
    log.write(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] ãƒ•ã‚©ãƒ«ãƒ€ãƒ„ãƒªãƒ¼æ›´æ–°å®Œäº†\n")

print("âœ… docs/folder_tree.md æ›´æ–°å®Œäº†")

tasks:
  # session_work.md ã‚’ä¿å­˜ã—ãŸã‚‰è‡ªå‹•ã§ sync.py å®Ÿè¡Œ
  - on: file:knowlage_grail/docs/session_work.md
    run: python knowlage_grail/scripts/sync.py
    label: "ğŸŒ€ Sync and Push on Save"

  # ãƒ•ã‚©ãƒ«ãƒ€ãƒ„ãƒªãƒ¼ã‚’è‡ªå‹•æ›´æ–°ï¼ˆ1åˆ†ã”ã¨ï¼‰
  - on: schedule: "* * * * *"
    run: python knowlage_grail/scripts/generate_folder_tree.py
    label: "ğŸ“‚ Auto Export Folder Tree"
    log: true

  # æ‰‹å‹•ã§ãƒ™ã‚¯ãƒˆãƒ«DBã«ingest
  - on: manual
    run: python knowlage_grail/scripts/ingest.py
    label: "ğŸ“¥ Manual Ingest"